<!DOCTYPE html>
<html>
    <head>
        <title><%= mii.meta.name %> - InfiniMii</title>
        <meta content="<%= mii.meta.name %>" property="og:title" />
        <meta content="<%= mii.desc %>" property="og:description" />
        <meta content="https://miis.kestron.com/mii?id=<%= mii.id %>" property="og:url" />
        <meta content="https://miis.kestron.com/miiImgs/<%= mii.id %>.jpg" property="og:image" />
        <meta content="#ff0000" data-react-helmet="true" name="theme-color" />
        <link rel="stylesheet" href="global.css">
        <link rel="stylesheet" href="miiPage.css">
    </head>
    <body>
        <%- partials.header %>
        <%- partials.accountDisplay %>
        <div class="content">
            <%- partials.sidebar %>

            <div class="mii-id-card">
                <!-- Card Header -->
                <div class="id-card-header">
                    <h2>Mii ID Card</h2>
                    <div class="card-number" onclick="copyId()">ID: <%= mii.id %></div>
                </div>

                <!-- Main Card Body -->
                <div class="id-card-body">
                    <!-- Left side: Mii Image -->
                    <div class="id-card-photo">
                        <img src="/miiImgs/<%= mii.id %>.jpg" alt="<%= mii.meta.name %>">
                        <div class="qr-code">
                            <a href="/miiQRs/<%= mii.id %>.jpg" target="_blank"><img src="/miiQRs/<%= mii.id %>.jpg" alt="QR Code"></a>
                            <a href="/miiQRs/<%= mii.id %>.jpg" target="_blank"><span>Download for 3DS</span></a>
                        </div>
                    </div>

                    <!-- Right side: Information -->
                    <div class="id-card-info">
                        <h1 class="mii-name"><%= mii.meta.name %></h1>
                        
                        <div class="info-grid">
                            <% if(mii.meta.creatorName?.length>0){ %>
                            <div class="info-item">
                                <span class="info-label">Creator Name</span>
                                <span class="info-value"><%= mii.meta.creatorName %></span>
                            </div>
                            <% } %>
                            
                            <div class="info-item">
                                <span class="info-label">Birthday</span>
                                <span class="info-value"><%= ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][mii.general.birthMonth] %> <%= mii.general.birthday %></span>
                            </div>

                            <% if(mii.general.height !== undefined) { %>
                            <div class="info-item">
                                <span class="info-label">Height</span>
                                <span class="info-value"><%= `${height.feet}' ${height.inches}"` %></span>
                            </div>
                            <% } %>

                            <% if(mii.general.weight !== undefined) { %>
                            <div class="info-item">
                                <span class="info-label">Weight [Experimental]</span>
                                <span class="info-value"><%= Math.round(weight.pounds) %>lbs</span>
                            </div>
                            <% } %>

                            <% if(mii.general.favoriteColor !== undefined) { %>
                            <div class="info-item">
                                <span class="info-label">Favorite Color</span>
                                <span class="info-value"><%= ["Red", "Orange", "Yellow", "Lime", "Green", "Blue", "Cyan", "Pink", "Purple", "Brown", "White", "Black"][mii.general.favoriteColor] %></span>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>

                <!-- Uploader Information -->
                <!-- Footer Section -->
                <div class="id-card-footer">
                    <% if(mii.official){ %>
                        <div class="uploader-info">
                            <span class="official-badge">‚≠ê Official Nintendo Mii</span>
                        </div>
                    <% } %>
                    <div class="uploader-info">
                        <span class="label">Uploaded by</span>
                        <a href="/user?user=<%= mii.uploader %>"><%= mii.uploader %></a>
                        <span class="date">on <%= new Date(mii.uploadedOn).toLocaleDateString() %></span>
                    </div>
                </div>
                <!-- Description -->
                <% if(mii.desc && mii.desc.length > 0) { %>
                    <div class="id-card-description">
                        <h3>About</h3>
                        <p><%= mii.desc %></p>
                    </div>
                <% } %>

                <!-- Actions -->
                <div class="id-card-actions">
                    <button class="btn-primary" onclick="copyId()">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 96 960 960" width="20" fill="currentColor">
                            <path d="M360 816q-33 0-56.5-23.5T280 736V256q0-33 23.5-56.5T360 176h360q33 0 56.5 23.5T800 256v480q0 33-23.5 56.5T720 816H360Zm0-80h360V256H360v480ZM200 976q-33 0-56.5-23.5T120 896V336h80v560h440v80H200Zm160-240V256v480Z"/>
                        </svg>
                        Copy Mii ID
                    </button>

                    <a href="/miiWii?id=<%= mii.id %>" class="btn-secondary">
                        <img src="/wii.png" width="20" height="20">
                        Download for Wii
                    </a>

                    <div class="vote-section">
                        <span onclick="likeMii(this,'<%= mii.id %>','<%= highlightedMii %>','<%= users[thisUser].roles.includes(`moderator`) %>')">
                            <% if(!users[thisUser].votedFor.includes(mii.id)&&!users[thisUser].submissions.includes(mii.id)){ %>
                                <svg xmlns="http://www.w3.org/2000/svg" class="like-icon" viewBox="0 96 960 960" fill="currentColor">
                                    <path d="m480 935-41-37q-105.768-97.121-174.884-167.561Q195 660 154 604.5T96.5 504Q80 459 80 413q0-90.155 60.5-150.577Q201 202 290 202q57 0 105.5 27t84.5 78q42-54 89-79.5T670 202q89 0 149.5 60.423Q880 322.845 880 413q0 46-16.5 91T806 604.5Q765 660 695.884 730.439 626.768 800.879 521 898l-41 37Zm0-79q101.236-92.995 166.618-159.498Q712 630 750.5 580t54-89.135q15.5-39.136 15.5-77.72Q820 347 778 304.5T670.225 262q-51.524 0-95.375 31.5Q531 325 504 382h-49q-26-56-69.85-88-43.851-32-95.375-32Q224 262 182 304.5t-42 108.816Q140 452 155.5 491.5t54 90Q248 632 314 698t166 158Zm0-297Z"/>
                                </svg>
                            <% } else { %>
                                <svg class="like-icon liked" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M0 0h24v24H0V0z" fill="none"/>
                                    <path d="M13.35 20.13c-.76.69-1.93.69-2.69-.01l-.11-.1C5.3 15.27 1.87 12.16 2 8.28c.06-1.7.93-3.33 2.34-4.29 2.64-1.8 5.9-.96 7.66 1.1 1.76-2.06 5.02-2.91 7.66-1.1 1.41.96 2.28 2.59 2.34 4.29.14 3.88-3.3 6.99-8.55 11.76l-.1.09z"/>
                                </svg>
                            <% } %>
                            <span class="vote-count"><%= mii.votes %></span>
                        </span>

                        <% if(users[thisUser].roles.includes('moderator')||users[thisUser].submissions.includes(mii.id)){ %>
                            <svg xmlns="http://www.w3.org/2000/svg" class="trash-icon" viewBox="0 96 960 960" fill="currentColor" onclick="deleteMii('<%= mii.id %>')">
                                <path d="M261 936q-24.75 0-42.375-17.625T201 876V306h-41v-60h188v-30h264v30h188v60h-41v570q0 24-18 42t-42 18H261Zm438-630H261v570h438V306ZM367 790h60V391h-60v399Zm166 0h60V391h-60v399ZM261 306v570-570Z"/>
                            </svg>
                        <% } else { %>
                            <svg xmlns="http://www.w3.org/2000/svg" class="report-icon" viewBox="0 -960 960 960" fill="currentColor" onclick="report()">
                                <path d="M200-120v-680h360l16 80h224v400H520l-16-80H280v280h-80Zm300-440Zm86 160h134v-240H510l-16-80H280v240h290l16 80Z"/>
                            </svg>
                        <% } %>
                    </div>
                </div>

                <!-- Moderator Tools -->
                <% if(users[thisUser]?.roles.includes('moderator')){ %>
                    <div class="moderator-tools">
                        <div class="mod-tools-header" onclick="toggleModTools()">
                            <h3>üõ†Ô∏è Moderator Tools</h3>
                            <span class="dropdown-arrow" id="modToolsArrow">‚ñº</span>
                        </div>
                        
                        <div class="mod-tools-content" id="modToolsContent">
                            <div class="mod-tool-grid">
                                <!-- Edit Mii Name -->
                                <div class="mod-tool-item">
                                    <label>Mii Name:</label>
                                    <input type="text" id="editMiiName" value="<%= mii.meta.name %>" placeholder="Mii Name">
                                    <button onclick="updateMiiField('name', document.getElementById('editMiiName').value)">Update Name</button>
                                </div>

                                <!-- Edit Description -->
                                <div class="mod-tool-item">
                                    <label>Description:</label>
                                    <textarea id="editDesc" rows="3" placeholder="Description"><%= mii.desc %></textarea>
                                    <button onclick="updateMiiField('desc', document.getElementById('editDesc').value)">Update Description</button>
                                </div>

                                <!-- Edit Creator Name -->
                                <div class="mod-tool-item">
                                    <label>Creator Name (in Mii file):</label>
                                    <input type="text" id="editCreatorName" value="<%= mii.meta.creatorName || '' %>" placeholder="Creator Name">
                                    <button onclick="updateMiiField('creatorName', document.getElementById('editCreatorName').value)">Update Creator</button>
                                </div>

                                <!-- Switch Uploader -->
                                <div class="mod-tool-item">
                                    <label>Change Uploader:</label>
                                    <input type="text" id="editUploader" value="<%= mii.uploader %>" placeholder="Username">
                                    <button onclick="updateMiiField('uploader', document.getElementById('editUploader').value)">Change Uploader</button>
                                </div>

                                <!-- Toggle Official Status -->
                                <div class="mod-tool-item">
                                    <label>Official Mii Status:</label>
                                    <div class="toggle-container">
                                        <input type="checkbox" id="officialCheckbox" <%= mii.official ? 'checked' : '' %>>
                                        <label for="officialCheckbox">
                                            <% if(mii.official) { %>
                                                ‚úÖ This is an Official Mii
                                            <% } else { %>
                                                ‚ùå Not an Official Mii
                                            <% } %>
                                        </label>
                                    </div>
                                    <button onclick="toggleOfficial()">Update Official Status</button>
                                </div>

                                <!-- Regenerate QR Code -->
                                <div class="mod-tool-item">
                                    <label>Regenerate QR Code:</label>
                                    <button onclick="regenerateQR()">üîÑ Regenerate QR</button>
                                    <span id="qrStatus"></span>
                                </div>

                                <!-- Delete Mii -->
                                <div class="mod-tool-item mod-tool-danger">
                                    <label>Delete Mii:</label>
                                    <button class="danger-btn" onclick="confirmDeleteMii()">üóëÔ∏è Delete Mii</button>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
            <%- partials.featuredMiis %>
        </div>
        
        <%- partials.footer %>
        
        <script src="global.js"></script>
        <script>
            function copyId(){
                navigator.clipboard.writeText("<%= mii.id %>");
            }
            function report(){
                var what=prompt("What would you like to report this Mii for?");
                fetch("/reportMii?id=<%= mii.id %>&what="+encodeURIComponent(what));
            }
        </script>

        <!--Moderator Tools Functions - Because EJS runs server side, and the client only sees the result of the compilation, this prevents unnecessary JS from loading that doesn't need to be sent-->
        <% if(users[thisUser]?.roles.includes('moderator')){ %>
            <script>
                function toggleModTools() {
                    const content = document.getElementById('modToolsContent');
                    const arrow = document.getElementById('modToolsArrow');
                    
                    content.classList.toggle('expanded');
                    arrow.classList.toggle('rotated');
                }

                async function updateMiiField(field, value) {
                    if (!value || value.trim() === '') {
                        alert('Please enter a valid value');
                        return;
                    }

                    const confirmed = confirm(`Are you sure you want to update the ${field}?`);
                    if (!confirmed) return;

                    try {
                        const response = await fetch('/updateMiiField', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                id: '<%= mii.id %>',
                                field: field,
                                value: value
                            })
                        });

                        const result = await response.json();
                        
                        if (result.okay) {
                            alert(`Successfully updated ${field}!`);
                            location.reload();
                        }
                        else {
                            alert(`Error: ${result.error || 'Unknown error'}`);
                        }
                    }
                    catch (error) {
                        console.error('Error:', error);
                        alert('Failed to update. Please try again.');
                    }
                }

                async function regenerateQR() {
                    const confirmed = confirm('Are you sure you want to regenerate the QR code?');
                    if (!confirmed) return;

                    const statusEl = document.getElementById('qrStatus');
                    statusEl.textContent = 'Regenerating...';
                    statusEl.style.color = '#FFA500';

                    try {
                        const response = await fetch('/regenerateQR?id=<%= mii.id %>');
                        const result = await response.json();
                        
                        if (result.okay) {
                            statusEl.textContent = '‚úì Done!';
                            statusEl.style.color = '#4CAF50';
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        }
                        else {
                            statusEl.textContent = `‚úó Error: ${result.error}`;
                            statusEl.style.color = '#f44336';
                        }
                    }
                    catch (error) {
                        console.error('Error:', error);
                        statusEl.textContent = '‚úó Failed';
                        statusEl.style.color = '#f44336';
                    }
                }

                async function confirmDeleteMii() {
                    const miiName = '<%= mii.meta.name %>';
                    const confirmed = confirm(`Are you ABSOLUTELY SURE you want to DELETE the Mii "${miiName}"?\n\nThis action CANNOT be undone!`);
                    
                    if (!confirmed) return;

                    const doubleCheck = prompt(`Type "DELETE" to confirm deletion of ${miiName}:`);
                    if (doubleCheck !== 'DELETE') {
                        alert('Deletion cancelled.');
                        return;
                    }

                    try {
                        const response = await fetch('/deleteMii?id=<%= mii.id %>');
                        const result = await response.json();
                        
                        if (result.okay) {
                            alert('Mii deleted successfully');
                            window.location.href = '/';
                        } else {
                            alert('Error deleting Mii');
                        }
                    }
                    catch (error) {
                        console.error('Error:', error);
                        alert('Failed to delete Mii');
                    }
                }

                async function toggleOfficial() {
                    const isOfficial = document.getElementById('officialCheckbox').checked;
                    
                    const confirmed = confirm(`Are you sure you want to mark this Mii as ${isOfficial ? 'OFFICIAL' : 'NOT OFFICIAL'}?\n\nOfficial Miis are shown with a special badge.`);
                    if (!confirmed) return;

                    try {
                        const response = await fetch('/toggleMiiOfficial', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                id: '<%= mii.id %>',
                                official: isOfficial
                            })
                        });

                        const result = await response.json();
                        
                        if (result.okay) {
                            alert(`Mii official status updated!`);
                            location.reload();
                        }
                        else {
                            alert(`Error: ${result.error || 'Unknown error'}`);
                        }
                    } 
                    catch (error) {
                        console.error('Error:', error);
                        alert('Failed to update official status');
                    }
            }
            </script>
        <% } %>
    </body>
</html>