<!DOCTYPE html>
<html>
    <head>
        <%
        const pageTitle = 'My Private Miis - InfiniMii';
        const pageDesc = 'Manage your private Mii collection. Review, edit, and publish your Miis when ready.';
        const canonicalUrl = `${baseUrl}/myPrivateMiis`;
        const keywords = 'private miis, mii collection, manage miis';
        %>
        <%- partials.metaTags %>
        <%- partials.structuredData %>
        <link rel='stylesheet' href="/global.css">
        <link rel="stylesheet" href="/utilityPages.css">
        <link rel="stylesheet" href="/privateMiis.css">
    </head>
    <body>
        <%- partials.header %>
        <%- partials.accountDisplay %>
        <main class='content' role="main">
            <%- partials.sidebar %>
            <div class='private-miis-container'>
                <div class="private-header">
                    <h1>üîí My Private Miis</h1>
                    <p class="limit-info">
                        <%= privateMiis.length %> / <%= privateLimit %> private Miis
                    </p>
                    <p class="info-text">
                        These Miis are uploaded but not yet published. Only you and moderators can see them.
                        Publish them to make them visible to everyone!
                    </p>
                    <a href="/upload" class="upload-button">üì§ Upload New Mii</a>
                </div>

                <% if(privateMiis.length > 0) { %>
                    <div id="private-miis-grid">
                        <% for(var i=0; i<privateMiis.length; i++){ %>
                            <article class="private-mii-card" data-mii-id="<%= privateMiis[i].id %>">
                                <a href="<%= '/mii/'+privateMiis[i].id %>" aria-label="View <%= privateMiis[i].meta?.name || privateMiis[i].name %>">
                                    <img src="/privateMiiImgs/<%= privateMiis[i].id %>.png" 
                                         onerror="this.src='/privateMiiImgs/<%= privateMiis[i].id %>.png'"
                                         alt="<%= privateMiis[i].meta?.name || privateMiis[i].name %>"
                                         loading="lazy">
                                </a>
                                <div class="mii-info">
                                    <h3><%= privateMiis[i].meta?.name || privateMiis[i].name %></h3>
                                    <% if(privateMiis[i].desc) { %>
                                        <p class="mii-desc">
                                            <%= privateMiis[i].desc.length > 80 ? 
                                                privateMiis[i].desc.substring(0, 80) + '...' : 
                                                privateMiis[i].desc %>
                                        </p>
                                    <% } %>
                                    <% if(privateMiis[i].blockedFromPublishing) { %>
                                        <div class="blocked-notice">
                                            üö´ Blocked from publishing
                                            <% if(privateMiis[i].blockReason) { %>
                                                <small><%= privateMiis[i].blockReason %></small>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="mii-actions">
                                    <% if(!privateMiis[i].blockedFromPublishing) { %>
                                        <button class="publish-btn" onclick="publishMii('<%= privateMiis[i].id %>')" aria-label="Publish <%= privateMiis[i].meta?.name || privateMiis[i].name %>">
                                            üì§ Publish
                                        </button>
                                    <% } %>
                                    <button class="delete-btn" onclick="deleteMii('<%= privateMiis[i].id %>')" aria-label="Delete <%= privateMiis[i].meta?.name || privateMiis[i].name %>">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </article>
                        <% } %>
                    </div>
                <% } else { %>
                    <div class="no-miis">
                        <p>You don't have any private Miis yet.</p>
                        <a href="/upload" class="upload-button">üì§ Upload Your First Mii</a>
                    </div>
                <% } %>
            </div>
            <%- partials.featuredMiis %>
        </main>
        <%- partials.footer %>
        
        <script>
            async function publishMii(miiId) {
                if (!confirm('Are you sure you want to publish this Mii? It will be visible to everyone.')) {
                    return;
                }
                
                try {
                    const response = await fetch('/publishMii', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ miiId })
                    });
                    
                    const data = await response.json();
                    
                    if (data.okay) {
                        alert('Mii published successfully!');
                        location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to publish Mii'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error publishing Mii');
                }
            }
            
            async function deleteMii(miiId) {
                if (!confirm('Are you sure you want to delete this Mii? This cannot be undone.')) {
                    return;
                }
                
                try {
                    const response = await fetch('/deleteMii?id=' + miiId);
                    const data = await response.text();
                    
                    if (data.includes('true')) {
                        alert('Mii deleted successfully');
                        location.reload();
                    } else {
                        alert('Error deleting Mii');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting Mii');
                }
            }
        </script>
    </body>
</html>